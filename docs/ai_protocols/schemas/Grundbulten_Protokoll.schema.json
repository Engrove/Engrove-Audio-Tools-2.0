{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/grundbulten_protocol.schema.json",
  "title": "Schema för Grundbulten – Universell filhantering (chattsession)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "protocolId",
    "file_path",
    "title",
    "version",
    "strict_mode",
    "mode",
    "purpose",
    "goals",
    "metadata",
    "terminology_and_policy",
    "gates",
    "policies",
    "steps",
    "appendices"
  ],
  "properties": {
    "protocolId": {
      "type": "string",
      "pattern": "^P-GB-\\d+(?:\\.\\d+)?$"
    },
    "file_path": {
      "type": "string",
      "pattern": "^docs/ai_protocols/Grundbulten_Protokoll\\.md$"
    },
    "title": { "$ref": "#/$defs/nonEmptyString" },
    "version": {
      "type": "string",
      "pattern": "^\\d+(?:\\.\\d+)*$"
    },
    "strict_mode": { "const": true },
    "mode": { "const": "literal" },
    "purpose": { "$ref": "#/$defs/nonEmptyString" },
    "goals": { "$ref": "#/$defs/nonEmptyString" },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["date", "external_reviewer"],
      "properties": {
        "date": { "type": "string", "format": "date" },
        "external_reviewer": { "$ref": "#/$defs/nonEmptyString" }
      }
    },
    "terminology_and_policy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["refaktor_flag", "quantitative_diff_threshold_default"],
      "properties": {
        "refaktor_flag": { "$ref": "#/$defs/nonEmptyString" },
        "quantitative_diff_threshold_default": { "$ref": "#/$defs/nonEmptyString" }
      }
    },
    "gates": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/gate" }
    },
    "policies": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/policy" }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/step" }
    },
    "appendices": {
      "type": "object",
      "additionalProperties": false,
      "required": ["A", "B", "C", "D", "E"],
      "properties": {
        "A": {
          "type": "object",
          "additionalProperties": false,
          "required": ["typed_verification_matrix", "general"],
          "properties": {
            "typed_verification_matrix": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["type", "rules"],
                "properties": {
                  "type": { "$ref": "#/$defs/nonEmptyString" },
                  "rules": {
                    "type": "array",
                    "minItems": 1,
                    "items": { "$ref": "#/$defs/nonEmptyString" }
                  }
                }
              }
            },
            "general": { "$ref": "#/$defs/nonEmptyString" }
          }
        },
        "B": {
          "type": "object",
          "additionalProperties": false,
          "required": ["anti_placeholder_regex"],
          "properties": {
            "anti_placeholder_regex": { "$ref": "#/$defs/nonEmptyString" }
          }
        },
        "C": {
          "type": "object",
          "additionalProperties": false,
          "required": ["chat_mode"],
          "properties": {
            "chat_mode": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/nonEmptyString" }
            }
          }
        },
        "D": {
          "type": "object",
          "additionalProperties": false,
          "required": ["ci_recipe_template_yaml"],
          "properties": {
            "ci_recipe_template_yaml": { "$ref": "#/$defs/nonEmptyString" }
          }
        },
        "E": {
          "type": "object",
          "additionalProperties": false,
          "required": ["delivery_matrix"],
          "properties": {
            "delivery_matrix": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["task_type", "recommended_format", "rationale"],
                "properties": {
                  "task_type": { "$ref": "#/$defs/nonEmptyString" },
                  "recommended_format": { "$ref": "#/$defs/nonEmptyString" },
                  "rationale": { "$ref": "#/$defs/nonEmptyString" }
                }
              }
            }
          }
        }
      }
    }
  },
  "$defs": {
    "nonEmptyString": { "type": "string", "minLength": 1 },
    "gate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "abort_on_violation"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^G(?:-1|[0-5])$"
        },
        "title": { "$ref": "#/$defs/nonEmptyString" },
        "abort_on_violation": { "type": "boolean" },
        "rule": { "$ref": "#/$defs/nonEmptyString" },
        "threshold": {
          "type": "string",
          "pattern": "^\\d{1,3}%$"
        },
        "condition": { "$ref": "#/$defs/nonEmptyString" },
        "action": { "$ref": "#/$defs/nonEmptyString" },
        "checks": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "policy_forbid_estimated_diff": {
          "type": "object",
          "additionalProperties": false,
          "required": ["rule", "on_missing_reference_or_hash_mismatch"],
          "properties": {
            "rule": { "$ref": "#/$defs/nonEmptyString" },
            "on_missing_reference_or_hash_mismatch": { "$ref": "#/$defs/nonEmptyString" }
          }
        },
        "truncation_detector": {
          "type": "object",
          "additionalProperties": false,
          "required": ["method", "abort_conditions"],
          "properties": {
            "method": { "$ref": "#/$defs/nonEmptyString" },
            "abort_conditions": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/nonEmptyString" }
            }
          }
        },
        "start_end_preserver": {
          "type": "object",
          "additionalProperties": false,
          "required": ["rule"],
          "properties": {
            "rule": { "$ref": "#/$defs/nonEmptyString" }
          }
        }
      }
    },
    "policy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "rules"],
      "properties": {
        "id": { "$ref": "#/$defs/nonEmptyString" },
        "title": { "$ref": "#/$defs/nonEmptyString" },
        "rules": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        }
      }
    },
    "role": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "duty"],
      "properties": {
        "name": { "$ref": "#/$defs/nonEmptyString" },
        "duty": { "$ref": "#/$defs/nonEmptyString" }
      }
    },
    "commentSyntaxRow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ext", "syntax", "status"],
      "properties": {
        "ext": { "$ref": "#/$defs/nonEmptyString" },
        "syntax": { "$ref": "#/$defs/nonEmptyString" },
        "status": { "$ref": "#/$defs/nonEmptyString" }
      }
    },
    "standards": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "javascript_vue": { "$ref": "#/$defs/nonEmptyString" },
        "python": { "$ref": "#/$defs/nonEmptyString" }
      }
    },
    "substep": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": ["string", "integer"],
          "pattern": "^[0-9]+[a-z]?$"
        },
        "title": { "$ref": "#/$defs/nonEmptyString" },
        "rule": { "$ref": "#/$defs/nonEmptyString" },
        "comment_syntax_table": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/commentSyntaxRow" }
        },
        "example": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "scope": { "$ref": "#/$defs/nonEmptyString" },
        "standards": { "$ref": "#/$defs/standards" },
        "format": { "$ref": "#/$defs/nonEmptyString" },
        "checks": {
          "type": "object",
          "additionalProperties": true
        },
        "path": { "$ref": "#/$defs/nonEmptyString" },
        "required_fields": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        }
      }
    },
    "verificationLog": {
      "type": "object",
      "additionalProperties": false,
      "required": ["required", "fields", "metrics_table_markdown_template"],
      "properties": {
        "required": { "type": "boolean" },
        "fields": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "metrics_table_markdown_template": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        }
      }
    },
    "step": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title"],
      "properties": {
        "id": { "type": "integer", "minimum": 0 },
        "title": { "$ref": "#/$defs/nonEmptyString" },
        "rules": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "substeps": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/substep" }
        },
        "code": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "non_code": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "general": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "verification_log": { "$ref": "#/$defs/verificationLog" },
        "example_markdown": { "$ref": "#/$defs/nonEmptyString" },
        "abort_on_fail": { "type": "boolean" },
        "roles": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/role" }
        },
        "attempt_counter": { "$ref": "#/$defs/nonEmptyString" },
        "forced_escalations": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/nonEmptyString" }
        },
        "meta_protocol": { "$ref": "#/$defs/nonEmptyString" },
        "note_binding": { "$ref": "#/$defs/nonEmptyString" }
      }
    }
  }
}
